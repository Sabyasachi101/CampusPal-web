rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the document owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================
    // USERS COLLECTION
    // ============================
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      // Users can only create/update their own profile
      allow create, update: if isOwner(userId);
      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // ============================
    // POSTS COLLECTION
    // ============================
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isAuthenticated();
      // Only authenticated users can create posts
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.authorId;
      // Post author can update/delete their posts
      // Anyone authenticated can update likes, likeCount, and commentCount
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.authorId ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likeCount'])) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']))
      );
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.authorId;
    }
    
    // ============================
    // COMMENTS COLLECTION
    // ============================
    match /comments/{commentId} {
      // Anyone authenticated can read comments
      allow read: if isAuthenticated();
      // Only authenticated users can create comments
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.authorId;
      // Only comment author can update/delete
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.authorId;
    }
    
    // ============================
    // FRIEND REQUESTS COLLECTION
    // ============================
    match /friendRequests/{requestId} {
      // Users can read friend requests where they are sender or recipient
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.recipientId);
      
      // Users can create friend requests where they are the sender
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId &&
        request.resource.data.senderId != request.resource.data.recipientId;
      
      // Users can update friend requests where they are the recipient (accept/decline)
      // or sender (cancel)
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.recipientId || 
         request.auth.uid == resource.data.senderId);
      
      // Users can delete their own sent or received requests
      allow delete: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.recipientId);
    }
    
    // ============================
    // CHATS COLLECTION
    // ============================
    match /chats/{chatId} {
      // Users can read chats they are participants in
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Users can create chats where they are listed as a participant
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants &&
        request.auth.uid == request.resource.data.createdBy;
      
      // Participants can update chat (for last message, unread counts, etc.)
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Only creator can delete chat
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.createdBy;
    }
    
    // ============================
    // MESSAGES COLLECTION
    // ============================
    match /messages/{messageId} {
      // Users can read messages from chats they are in
      // Note: We can't validate chat membership here directly without an extra read,
      // so we rely on the client to only request messages from their chats
      allow read: if isAuthenticated();
      
      // Users can create messages where they are the sender
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId;
      
      // Users can update their own messages (for edits, etc.)
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.senderId;
      
      // Users can delete their own messages
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.senderId;
    }
    
    // ============================
    // NOTIFICATIONS COLLECTION
    // ============================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && 
        request.auth.uid == resource.data.recipientId;
      
      // Anyone authenticated can create notifications
      allow create: if isAuthenticated();
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.recipientId;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.recipientId;
    }
    
    // ============================
    // EVENTS COLLECTION
    // ============================
    match /events/{eventId} {
      // Anyone authenticated can read events
      allow read: if isAuthenticated();
      // Only authenticated users can create events
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.organizerId;
      // Only event organizer can update/delete, or anyone can update attendees
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.organizerId ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees', 'commentCount']))
      );
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.organizerId;
    }
    
    // ============================
    // MARKETPLACE ITEMS COLLECTION
    // ============================
    match /marketplaceItems/{itemId} {
      // Anyone authenticated can read marketplace items
      allow read: if isAuthenticated();
      // Only authenticated users can create items
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.sellerId;
      // Only item seller can update/delete
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.sellerId;
    }
    
    // ============================
    // LOST & FOUND ITEMS COLLECTION
    // ============================
    match /lostFound/{itemId} {
      // Anyone authenticated can read lost & found items
      allow read: if isAuthenticated();
      // Only authenticated users can create items
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.reporterId;
      // Only reporter can update/delete
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.reporterId;
    }
    
    // ============================
    // CLUBS COLLECTION
    // ============================
    match /clubs/{clubId} {
      // Anyone authenticated can read clubs
      allow read: if isAuthenticated();
      // Only authenticated users can create clubs
      allow create: if isAuthenticated();
      // Club admins can update/delete (implement admin field in your data)
      allow update, delete: if isAuthenticated();
    }
  }
}
